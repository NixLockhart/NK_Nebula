# 自定义配置开发指南

本文档说明如何通过 APP 界面配置来扩展系统功能。

## 目录

1. [架构概述](#架构概述)
2. [添加自定义传感器](#添加自定义传感器)
3. [添加开关控制](#添加开关控制)
4. [添加执行操作](#添加执行操作)
5. [阈值规则配置](#阈值规则配置)

---

## 架构概述

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│   Flutter APP   │────▶│     Server      │────▶│   IoT 设备      │
│                 │◀────│                 │◀────│                 │
└─────────────────┘      └─────────────────┘      └─────────────────┘
        │                       │                        │
   配置界面添加             透传存储                    代码实现
   键值配置              不关心具体内容               匹配键值处理
```

**核心思想**: 服务器只做消息透传和配置存储，不关心具体的传感器/控制类型。只需要：
1. 在 APP 配置页面添加键值映射
2. 在设备端代码中实现对应键值的发送/接收处理

---

## 添加自定义传感器

### 示例：添加气体浓度传感器 (gas)

#### APP 端配置

在 APP 的 **配置** 页面：

1. 点击 **传感器配置** 右侧的 "+" 按钮
2. 填写配置：
   - **键值**: `gas` (与设备发送的 JSON 键名一致)
   - **显示名称**: `气体浓度`
   - **单位**: `%`
   - **图标**: 选择合适的图标

#### 数据流

```
设备                        服务器                      APP
 │                            │                          │
 │  {"p":{"gas":35,...}}      │                          │
 ├───────────────────────────►│                          │
 │                            │  存储到 sensor_data 表    │
 │                            │  推送 data.realtime      │
 │                            ├─────────────────────────►│
 │                            │                          │  显示 "气体浓度: 35%"
```

---

## 添加开关控制

### 示例：添加蓝牙开关 (bluetooth)

#### APP 端配置

在 APP 的 **配置** 页面：

1. 点击 **开关控制** 右侧的 "+" 按钮
2. 填写配置：
   - **键值**: `bluetooth`
   - **显示名称**: `蓝牙开关`
   - **图标**: 选择 "蓝牙"

配置后系统会自动生成：
- `cmd_on`: `bluetooth_on`
- `cmd_off`: `bluetooth_off`

#### 命令流

```
APP                         服务器                      设备
 │                            │                          │
 │  用户点击蓝牙开关 ON        │                          │
 │  cmd.control               │                          │
 │  {control_key:"bluetooth"  │                          │
 │   state:"on"}              │                          │
 ├───────────────────────────►│                          │
 │                            │  查询 cmd_on             │
 │                            │  = "bluetooth_on"        │
 │                            │  {"t":"ctl",             │
 │                            │   "p":{"cmd":"bluetooth_on"}}
 │                            ├─────────────────────────►│
 │                            │                          │  执行开启蓝牙
 │                            │                          │
 │                            │◀─────────────────────────┤ ACK
 │◀───────────────────────────┤                          │
 │  成功                       │                          │
```

---

## 添加执行操作

### 示例：添加传感器校准操作 (calibrate)

#### APP 端配置

在 APP 的 **配置** 页面：

1. 点击 **执行操作** 右侧的 "+" 按钮
2. 填写配置：
   - **键值**: `calibrate`
   - **显示名称**: `传感器校准`
   - **图标**: 选择合适的图标

#### 执行操作 vs 开关控制的区别

| 特性 | 开关控制 (Control) | 执行操作 (Action) |
|------|-------------------|-------------------|
| 状态 | 有状态 (ON/OFF) | 无状态 |
| 命令 | 两个 (xxx_on, xxx_off) | 一个 |
| UI | 开关按钮 | 普通按钮 |
| 适用场景 | 灯、水泵、风扇等 | 校准、重启、自检等 |

---

## 阈值规则配置

### 示例：土壤湿度低于 40% 时自动浇水

#### APP 端配置

在 APP 的 **配置** 页面：

1. 点击 **阈值规则** 右侧的 "+" 按钮
2. 填写配置：
   - **传感器**: 选择 `土壤湿度`
   - **条件**: 选择 `小于`
   - **阈值**: 输入 `40`
   - **控制项**: 选择 `水泵`
   - **动作**: 选择 `开启`

#### 条件类型

| 条件 | 说明 |
|------|------|
| gt | 大于 |
| lt | 小于 |
| gte | 大于等于 |
| lte | 小于等于 |
| eq | 等于 |

---

## 配置对照表

| APP 配置项 | 设备 JSON 键值 | 说明 |
|-----------|-----------------|------|
| 传感器键值 | `{"p":{"键值":数值}}` | 数据上报时的字段名 |
| 控制项键值 | `{"p":{"cmd":"键值_on"}}` | 服务器下发的命令字符串 |
| 操作键值 | `{"p":{"cmd":"键值"}}` | 服务器下发的命令字符串 |

---

## 常见问题

**Q: APP 显示 "--" 没有数据？**

A: 检查设备发送的 JSON 中键值是否与 APP 配置的键值完全一致（区分大小写）。

**Q: 控制命令没有响应？**

A: 检查设备是否正确解析了 `xxx_on` / `xxx_off` 命令字符串。

**Q: 如何调试？**

A: 设备端打印收发的 JSON 消息，对比 APP 配置的键值。

---

*文档版本: 1.0*
*最后更新: 2025-12-16*
